\documentclass{itatnew}

\usepackage{paralist} % inparaenum support
\usepackage{varioref} % added by Viliam for \vref
\usepackage{xcolor} % added by Viliam for \textcolor

\usepackage{caption}
\usepackage{subcaption}
\usepackage{graphicx}
\usepackage{textcomp} % used for degrees celsius
\usepackage{booktabs}
\usepackage[british]{babel}

% ==========================================
% Custom commands (by Viliam)
% ==========================================
\newcommand{\FOCAL}[3]{ % usage: \FOCAL{R}{M}{op}
  \ifmmode
    #1{\stackrel{\mathtt{#3}}{\circ}}#2
  \else
    \begin{math}\FOCAL{#1}{#2}{#3}\end{math}
  \fi
}
\newcommand{\SOHUP}{
  \ifmmode
    SoH^\uparrow
  \else
  \begin{math}\SOHUP\end{math}
  \fi
}
\newcommand{\SOHDOWN}{
  \ifmmode
    SoH^\downarrow
  \else
  \begin{math}\SOHDOWN\end{math}
  \fi
}
% ==========================================


\begin{document}

\title{Stable Hot Spot Analysis (Draft)}

\author{
  Marc Gassenschmidt \and
  Viliam Simko  \and
  Julian Bruns
  \\
  \email{todo@fzi.de},
  \email{simko@fzi.de},
  \email{bruns@fzi.de}
}

\institute{
  FZI Forschungszentrum Informatik\\
  am Karlsruher Institut f\"ur Technologie\\
  76131, Haid-und-Neu-Str. 10-14\\
  Karlsruhe, Germany
}
  
\maketitle              % typeset the title of the contribution



\begin{abstract}
Hot spot analysis is essential for geo-statistics.
It supports decision making by detecting points
as well as areas of interest in comparison to their
neighbourhood. However, these methods are dependent
on different parameters, ranging from the resolution
of the study area to the size of their neighbourhood.
This dependence can lead to instabilities of the detected
hotspots, where the results can highly vary between
different parameters. A decision maker can therefore ask
how valid the analysis actually is.
%
In this study, we examine the impact of key parameters
on the stability of the hotspots, namely the size of
the neighbourhood, the resolution and the size of the
study area, as well as the influence of the ratio between
those parameters.
%
We compute the hotspots with the well known Getis-Ord ($G^*$)
statistic as well as its modification, the \emph{Focal $G^*$} statistic.
We measure the stability of the hotspot analysis using
a recently introduced \emph{stability of hotspots} metric (SoH)
and compare the results to intuitive visual analysis.
%
We evaluate the results on real world data with the well-known
yellow cab taxi data set from New York, Manhattan.
Our results indicate a negative impact on the stability with
an increase of the size of the neighbourhood as well as
a reduction of the size of the study area, regardless of
the resolution.
\end{abstract}


\section{Introduction}
The goal of hotspot analysis is the detection and identification of interesting areas. It achieves this goal by computing statistically significant deviations from the mean value of a given study area. This allows a decision maker to easily identify those areas of interest and allows further focus in sub-sequential data analysis or the decision focus. Typical applications range from crime detection over identification of disease outbreaks to urban heat islands. In such applications, scarce resources are then often applied in only those identified hotspots or used as the basis for the allocation. The general approach is an unsupervised learning method similar to a cluster analysis. 

But, similar to a cluster analysis, there does exist a high dependency of the identified hotspots on the detection method and in particular the parametrization of this method. The identified areas as well as their shape can vary highly. This volatility can lead to a decrease in trust in the result or in suboptimal allocations of scarce resources. Therefore it is necessary to measure and evaluate the stability of a hotspot analysis as well as the different parametrizations. 
In our initial work (Hier Bruns and VIliam 2017), we introduced a method to measure the stability of hotspots, the \emph{stability of hotspots} metric (SoH) and showed its use on the basis of temperature data .   
Here, we build upon that work and examine in more detail the impact of the different instantiations of the most typical parameter. We use the well known Getis-Ord statistic \cite{Ord.1995}, the standard $G^*$, and a modification of this statistic, the focal $G^*$ (citate bruns and viliam). Those parameter are the size of the study area (focal matrix), the detail of the resolution (zoom) and the size of the neighbourhood (weight matrix). By varying over these parameter, we can compare the stability for all possible combinations and isolate the effect of single parameter by aggregation over the other parameter. 
We evaluate on the well-known taxi data set to show the applicability on real world use cases as well as to enable a simple replication. 


\section{Related Work}

\subsection{Quality of Clustering}
The problem of assessing the quality in unsupervised learning is well known. In the case of the k-mean algorithm, the quality of the clustering is mostly dependent on the value of the \emph{k} and a miss-specification can lead to highly irregular clusters. In a simple 2D clustering, they can be easily recognized by visual analysis, but in higher dimensionality, this is impossible. One method, to measure the quality of such a clustering is the compactness of the clusters, see e.g. Song 2010 (http://ieeexplore.ieee.org/document/5558958/?part=1). This enables the comparison between different clusters. Another possibility is the Silhouette Coefficient by Kaufman et Rousseeuw 1990. This metric measures the similarity of objects in a cluster in comparison to other clusters. For density based clustering, e.g. for DBSCAN, OPTICS (Ankerst et al 1999) gives a simple method to tune the essential parameter for this clustering. This is only a small overview of methods to influence and measure the quality of different clustering methods. But it shows that this problem is not easily solved and dependent on the chosen algorithm. To our knowledge, there does not exist a method to overall measure the stability of a clustering.

\subsection{Hot Spot Analysis}
The goal of hotspot analysis is the detection of interesting areas as well as patterns in spatial information. One of the most fundamental approach is Moran´s I~\cite{MoranI}. There it is tested whether or
not a spatial dependency exists. This gives the information on global
dependencies in a data set. Upon this hypothesis test several geo-statistical
tests are based. The most well known are the Getis-Ord statistic~\cite{Ord.1995}
and LISA~\cite{Anselin.1995}. In both cases the general, the global statistic of
Moran´s I is applied in a local context. The goal is to detect not only global
values, but instead to focus on local hotspots and to measure the significance
of those local areas. A more in depth overview of methods to identify and visualize spatial patterns and areas of interest can be found in Shekhar et al (2011). 

\section{Stability of Hot Spot Analysis}
\label{sec:Metric}

Existing methods for determining hot spots are dependent on the parametrization
of the weight matrix as well as on the size of the study area. Intuitively,
increasing the size of a weight matrix has a "blurring" effect on the raster
(Fig.~\ref{def:TODO}a) whereas decreasing the size can be seen as a form of
"sharpening" (Fig.~\ref{def:TODO}b).

%TODO: add image showing and blurring/sharpening effects

%As we can see, hot spots are oftentimes disappearing or appearing unrelated to
%previously found hot spots. While these computations indeed show hot spots and
%the results are correct, they lack stability.

For a data analyst, when exploring the data interactively by choosing different
filter sizes (weight matrices) or point aggregation strategies (pixel sizes), it
is important that the position and size of a hot spot changes in a predictable
manner. We formalize the intuition in our stability metric.

%
%Consider the real-world example depicted in Fig.~\ref{fig:TempMaps}.
%%TODO: thermal flight -> NY taxi
%The temperature map of a morning thermal flight dataset 
%(Fig.~\ref{fig:TempMaps:a}) has been processed using $G^*$.
%
%%TODO: thermal flight -> NY taxi
%%TODO: need two images - G* and FocalG*
%\begin{figure}[htp]
%  \begin{subfigure}{1\linewidth}
%    \caption{Morning temperatures}
%    \includegraphics[width=\linewidth]{images/hotspot-rawtemp-1}
%    \label{fig:TempMaps:a}
%  \end{subfigure}
%  
%  \caption{
%    Karlsruhe city center.
%    Selected area of $2.4{\times}1.4\,km$.
%    Pixel size $5{\times}5\,m$.
%  }
%  \label{fig:TempMaps}
%\end{figure}


We define a hot spot found in comparably more coarse resolutions as
\emph{parent} (larger weight matrix or larger pixel size) and in finer
resolutions as \emph{child} (smaller weight matrix or smaller pixel size).

That is 

To be stable, one assumes that every parent has at
least one child and that each child has one parent. For a perfectly stable
interaction, it can be easily seen that the connection between parent and child
is a injective function and between child and parent a surjective function. To
measure the closeness of connection, we propose a metric called the
\emph{Stability of Hot spot} (SoH). It measures the deviation from a perfectly
stable transformation of resolutions.



In its downward property (from parent to child, injective) it is defined as:
\begin{equation}
  \label{eq:SoH-down}
  \SOHDOWN
    = \frac{ParentsWithChildNodes}{Parents}
    = \frac{|Parents \cap Children|}{|Parents|}
\end{equation}
And for its upward property (from child to parent, surjective):
\begin{equation}
  \label{eq:SoH-up}
  \SOHUP
    = \frac{ChildrenWithParent}{Children}
    = 1 - \frac{|Children - Parents|}{|Children|}
\end{equation}
where $ParentsWithChildNodes$ is the number of parents that have at least one 
\emph{child}, $Parents$ is the total number of \emph{parent}, 
$ChildrenWithParent$ is the number of children and $Children$ as the total 
number of children.
The SoH is defined for a range between 0 and 1, where 1 represents a perfectly 
stable transformation while 0 would be a transformation with no stability at 
all.

\section{Focal Getis-Ord} \label{sec:FocalGetisOrd}

\subsection{Dataset}

% extent
The two datasets (morning and evening flights) depicted in
Fig.~\ref{fig:ComparisonMorning} and Fig.~\ref{fig:ComparisonEvening} were
obtained from a thermal flight over the city of Karlsruhe on 26.09.2008 at
6:30--7:45 and 20:00--21:30. The flights were executed by the
Nachbarschaftsverband
Karlsruhe\footnote{http://www.nachbarschaftsverband-karlsruhe.de/}. A single
pixel in the raster represents an area of approximately $5{\times}5m$. The whole
dataset of size $35{\times}25\,km$ was cropped into the inner city area of
$2.4{\times}1.4\,km$. % temp range
The temperatures in our dataset range from -1.7°C to 18.3°C.
% missing values = NAs
Missing values in the dataset were interpolated using a focal median function
with a square matrix of 11x11 pixels, mainly for speeding up further
computations and to avoid special handling of NA values.


\subsection{Method}

In the following text, we use the notation \FOCAL{R}{M}{op} to denote a focal
operation $op$ applied on a raster $R$ with a focal window determined by a
matrix $M$. This is rougly eqivalent to a command \verb|focal(x=R, w=M, fun=op)|
from package \emph{raster} in the R programming language \cite{cran:raster}.

\begin{definition}[$G^*$ function on rasters]
  \label{def:GenericGetisOrdFunc}
  
  The function $G^*$ can be expressed as a raster operation:
  
  \begin{displaymath}
    G^*(R, W, st) =
    \frac{
      \FOCAL{R}{W}{sum} - M*\sum_{w \in W}{w}
    }{
      S \sqrt{
        \frac{
          N*\sum_{w \in W}{w^2} - (\sum_{w \in W}{w})^2
        }{
          N - 1
        }
      }
    }
  \end{displaymath}
  \noindent where:
  \begin{itemize}
    
    \item $R$ is the input raster.
    
    \item $W$ is a weight matrix of values between 0 and 1.
    
    \item $st = (N, M, S)$ is a parametrization specific to a particular version
    of the $G^*$ function. (Def.\vref{def:StdGetisOrdVersion} and
    \vref{def:FocalGetisOrdVersion}).
    
  \end{itemize}
\end{definition}

\begin{definition}[Standard $G^*$ parametrization]
  \label{def:StdGetisOrdVersion}
  
  Computes the parametrization $st$ as global statistics for all pixels in the
  raster $R$:
  
  \begin{itemize}
    \item $N$ represents the number of all pixels in $R$.
    \item $M$ represents the global mean of $R$.
    \item $S$ represents the global standard deviation of all pixels in $R$.
  \end{itemize}
\end{definition}

\begin{definition}[Focal $G^*$ parametrization]
  \label{def:FocalGetisOrdVersion}
  
  Let $F$ be a boolean matrix such that: $all(dim(F) \geq dim(W))$.
  This version uses focal operations to compute per-pixel statistics given by 
  the focal neighbourhood $F$ as follows:
  
  \begin{itemize}
    
    \item $N$ is a raster computed as a focal operation \FOCAL{R}{F}{sum}. Each
    pixel represents the number of pixels from $R$ convoluted with the matrix
    $F$. 
    
    \item $M$ is a raster computed as a focal mean \FOCAL{R}{F}{mean}, thus each
    pixel represents a mean value of its $F$-neighbourhood.
    
    \item $S$ is a raster computed as a focal standard deviation
    \FOCAL{R}{F}{sd}, thus each pixel represents a standard deviation of its
    $F$-neighbourhood.
    
  \end{itemize}
  
\end{definition}

\section{Results}
\subsection{Heatmap}
\begin{figure}[htp]
  \begin{subfigure}{\linewidth}
    \caption{FocalRelation}
    \includegraphics[width=\linewidth]{images/FocalRealationUp}
    \label{fig:FocalRelation}
  \end{subfigure}
  \hspace{1em}
  \begin{subfigure}{\linewidth}
    \caption{WeightRealtion}
    \includegraphics[width=\linewidth]{images/WeightRelationUp}
    \label{fig:WeightRealtion}
  \end{subfigure}
  \caption{Heatmap of Relation between size of weight matrix $W$ and focal matrix $F$}
  \label{fig:RealtionUp}
\end{figure}

\section{Evaluation}

- To evaluate, we compare G* with FocalG* on the same dataset.
- We use NY taxi dropoffs
- a single evaluation run is defined in Def.~\ref{def:EvalRun}.
- In an ideal case, we could produce a 3D-plot:
  - x-axis would be growing pixel sizes 100..1000 by 100 (aka zoom-out)
  - y-axis would be growing weight matrix sizes (e.g. 5..41 by 2)
  - z-axis would be performance of G* vs FocalG* x and y coordinates
  - we could also repeat the computation for multiple datasets to obtain 
  multiple samples and to compute error bars.
- due to paper size limit, we choose projection in which matrix size is set to 
constant 7x7 pixels and the only variable is the pixel size. This way, we 
produce a 2D plot. We also generate just a single sample.

\begin{definition}[Evaluation Run]
  \label{def:EvalRun}
  We define a single evaluation run as a tuple:
  \begin{displaymath}
    E = (V, m, p, w)
  \end{displaymath}
  \noindent where:
  \begin{itemize}
  
    \item $V$ is the input dataset of points, representing the taxi dropoffs in 
    our case.
    
    \item $m$ is the metric used, in our case either \SOHUP or \SOHDOWN.
    
    \item $p$ represents the pixel size for aggregating points from $V$, 
    e.g. $100 \times 100$ meters.
    
    \item $w$ represents the size of a weight matrix.
    In our case, we chose a weight matrix depicted in 
    Figure~\ref{fig:ExampleMatrices}(a) for both the G* and FocalG* cases.
  \end{itemize}
\end{definition}

%Fig.~\ref{fig:ComparisonMorning} and Fig.~\ref{fig:ComparisonEvening} show
%Standard and Focal $G^*$ computations for both morning and eventing datasets
%with weight matrix $W$ of size 3, 5, 7, 9, 15 and 31. In this figures, when 
%computing Focal
%$G^*$, the focal matrix $F$ has a constant size of $61{\times}61$ cells. 
%Example weight matrix $W$ and focal matrix $F$ are depicted in 
%Fig.~\ref{fig:ExampleMatrices}.

\begin{figure}[htp]
  \begin{subfigure}{\linewidth}
    \caption{FocalRelation}
    \includegraphics[width=\linewidth]{images/FocalRealationDown}
    \label{fig:FocalRelation}
  \end{subfigure}
  \hspace{1em}
  \begin{subfigure}{\linewidth}
    \caption{WeightRealtion}
    \includegraphics[width=\linewidth]{images/WeightRelationDown}
    \label{fig:WeightRealtion}
  \end{subfigure}
  \caption{Heatmap of Relation between size of weight matrix $W$ and focal matrix $F$}
  \label{fig:RealtionDown}
\end{figure}
\subsection{Clumping}

\subsection{Zoom}

Blueline is Focal $G^*$. Redline is $G^*$

\begin{figure}[htp]
  \begin{subfigure}{\linewidth}
    \caption{Upward}
    \includegraphics[width=\linewidth]{images/SoHZoomUp}
    \label{fig:UpwardZoom}
  \end{subfigure}
  \hspace{1em}
  \begin{subfigure}{\linewidth}
    \caption{Downward}
    \includegraphics[width=\linewidth]{images/SoHZoomDown}
    \label{fig:DownwardZoom}
  \end{subfigure}
  \caption{TODO}
  \label{fig:Zoom}
\end{figure}


\subsection{Blur}

The evaluation results are plotted in Fig.~\ref{fig:EvalResults}, each point in
the graph represents the \SOHUP metric (Eq.\ref{eq:SoH-up}) between two
$G^*$ generated using weight matrices of size $i$ and $i+2$. The focal matrix F
has a fixed size of $41{\times}41$

\begin{displaymath}
\SOHUP( G^*(R, W_i, st), G^*(R, W_{i+2}, st) )
\end{displaymath}

\begin{figure}[htp]
  \begin{subfigure}{\linewidth}
    \caption{Upward}
    \includegraphics[width=\linewidth]{images/SoHUpBlur}
    \label{fig:UpwardBlur}
  \end{subfigure}
  \hspace{1em}
  \begin{subfigure}{\linewidth}
    \caption{Downward}
    \includegraphics[width=\linewidth]{images/SoHDownBlur}
    \label{fig:DownwardBlur}
  \end{subfigure}
  \caption{TODO}
  \label{fig:Blur}
\end{figure}


\subsection{Results and Discussion}




The results for the hot spot analysis are found in
Fig.~\ref{fig:ComparisonMorning} and Fig.~\ref{fig:ComparisonEvening} for a
comparison of $G^*$ and the Focal $G^*$ statistic. It can easily be seen that
both versions produce similar results, but the focal versions produces a more
differentiated picture for larger weight matrices. Small differences on a
global scale are more pronounced on a regional scale and result in smaller and
finer areas for hot spots. This enables the detection of additional hot spots
and interesting areas which are most easily observable for the weight matrix of
size $7{\times}7$ in the evening (Fig.~\ref{fig:ComparisonEvening}). This
enables the detection of significant deviations from the surrounding area. 
In contrast the Standard $G^*$ statistic shows larger areas as important.
Therefore, depending on the need of a planner, the Focal $G^*$ statistic
is more helpful to identify individual areas of interest whereas the standard
$G^*$ statistic gives a more broad overview. For the identification of IUHI this
is quite important. As a city planer wishes to detect critical areas, it is
important to detect not only general hot areas, but also those points where the
most extreme differences in a local context exist. Finding those areas can help 
identify the underlying reasons or plan individual solutions.

Based on these images one can also see that the hot spots found by the Focal
$G^*$ statistic seem to be more stable. We compare their stability using only
the $ SoH^\uparrow$ for lack of space. A plot of the results can be found in
Fig.~\ref{fig:EvalResults}. Fig.~\ref{fig:EvalResults} compares the $
SoH^\uparrow$ between each increasing size of the weight matrix W. At a first
glance, one can see that the typical implementation with a square weight matrix
is the most unstable hot spot analysis, regardless of time of day. This is to be
expected as the binary weights increase the dependence on the weight matrix. The
use of a decreasing weight matrix perform better. As the more outlying data
points get less weight, this reduces the dependence on the weight matrix and
leads therefore to more stable results. Our proposed Focal $G^*$ statistic
achieves the most stable results in almost all cases. Only data points in a
restricted region around the area of interest may influence the significance
result. Through this restriction high values at key points gains more weight
regardless of the weight matrix and are therefore more independent of the weight
matrix. This increases the stability. The decrease in stability for the largest
weight matrices is most likely a result of the parametrization of the focal
matrix. With increasing size of the weight matrix in relation to the focal
matrix the value of each pixel is approaching to the mean of the area of the
weight matrix. As can be easily seen from Def.~\ref{def:GenericGetisOrdFunc}
then the value for every pixel would be zero.

\section{Conclusions and Future Work} \label{sec:Conclusion}

In this work, we generalized the Getis-Ord statistic to deal with the problem of
stability inherent in hot spot analysis. We identified possible underlying
reasons for this instability: The weight matrix as well as the size of the study
area. We developed a modified approach that deals with those two factors. The
result is a modified $G^*$ statistic called the \emph{Focal $G^*$ statistic}. It
reduces the study area used for comparison into regions and achieves through
this an increase in stability. To determine the effectiveness of our approach,
we propose a stability metric for hot spots called \emph{SoH}. To our knowledge
no such metric existed before this work. The SoH computes the ratio of
dependence of hot spots for different parametrizations of weight matrices. It
enables to express the stability between each parametrization using single value
restricted between zero and one. Based on this number one can decide which
parametrization to use and researchers can compare the stability of their
methods for unsupervised hot spot analyses. In particular, for temperature
values one wishes to detect those areas which have high differences regardless
of a particular parametrization. If a hot spot only appears for one
parametrization, the information gained for general use is quite small and can
even lead to an inefficient allocation of resources.

This research has several restrictions which have to be taken into account.
First, we only tested the $SoH^\uparrow$ metric. While we assume, based on our
graphical analysis, that the  $SoH^\downarrow$ stability should be similar, we
have no hard results. The results themselves are tested on two events in time
for a fixed area of the city of Karlsruhe. We have not tested it on smaller or
larger study areas, but we assume that the stability of the Focal $G^*$ would
stay the same whereas the stability of the $G^*$ statistic would increase with a
smaller study area and decrease with a larger study area. This follows the
reasoning that the impact of a singular point increases with a decrease of the
study area. To test this dependency is an interesting task for future work. The
last restriction is the fixed size in this work of the focal matrix for the
Focal $G^*$ approach. We only tested one size in this work, but it is highly
probable that the size of the focal matrix has an impact on the stability as
could be seen in Fig.~\ref{fig:EvalResults}. While an overall trend can be seen
in this work when the size of the weight matrix W and the focal matrix F are
almost identical, the exact ratio is beyond the scope of this work. The optimal
ratio as well as when the stability suffers from a too similar size are
interesting question for future work.

\section{Acknowledgements}
This work is part of the research project BigGIS (reference number: 01IS14012)
funded by the Federal Ministry of Education and Research (BMBF) within the
frame of the programme "Management and Analysis of Big Data" in "ICT 2020 --
Research for Innovations".
We thank the Nachbarschaftsverband Karlsruhe for the data of the thermal flight
over Karlsruhe. %
\noindent R-packages used: \verb|raster|~\cite{cran:raster}, 
\verb|knitr|~\cite{cran:knitr}

\bibliographystyle{plain}
\bibliography{bibfile}  % sigproc.bib is the name of the

\end{document}
